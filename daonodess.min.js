!function(e){var d=require("crypto"),f=require("net"),n=require("http"),p=require("ws");function r(){var s,u,c,l,r,h,t,n,o,i,a=(o=function(e,t,r){for(var n=new Array;0<e.length&&0<t.length;)r(e[0],t[0])<=0?n.push(e.shift()):n.push(t.shift());for(;0<e.length;)n.push(e.shift());for(;0<t.length;)n.push(t.shift());return n},i=function(e,t){var r;return e.length<2?e:(r=Math.ceil(e.length/2),o(i(e.slice(0,r),t),i(e.slice(r),t),t))});function e(e,t){this.key=e,this.method=t,this.iv_sent=!1,"table"===this.method&&(this.method=null),null!=this.method?this.cipher=this.get_cipher(this.key,this.method,1,d.randomBytes(32)):(t=r(this.key),this.encryptTable=t[0],this.decryptTable=t[1])}return h=Math.pow(2,32),c={},r=function(e){var r,n,t,o,i,s;if(c[e])return c[e];for(console.log("calculating ciphers"),s=new Array(256),t=new Array(256),(i=d.createHash("md5")).update(e),i=new Buffer(i.digest(),"binary"),n=i.readUInt32LE(0),r=i.readUInt32LE(4),o=0;o<256;)s[o]=o,o++;for(o=1;o<1024;)s=a(s,function(e,t){return(r%(e+o)*h+n)%(e+o)-(r%(t+o)*h+n)%(t+o)}),o++;for(o=0;o<256;)t[s[o]]=o,++o;return i=[s,t],c[e]=i},n=function(e,t){for(var r=0;r<t.length;)t[r]=e[t[r]],r++;return t},u={},s=function(e,t,r){var n,o,i,s,c,l,h;if(u[e+":"+t+":"+r])return u[e+":"+t+":"+r];for(c=[],n=i=0;n<t+r;)l=d.createHash("md5"),o=e,0<i&&(o=Buffer.concat([c[i-1],e])),l.update(o),l=l.digest(),c.push(l),n+=l.length,i+=1;return s=(h=Buffer.concat(c)).slice(0,t),h=h.slice(t,t+r),u[e]=[s,h],[s,h]},t={"aes-128-cfb":[16,16],"aes-192-cfb":[24,16],"aes-256-cfb":[32,16],"bf-cfb":[16,8],"camellia-128-cfb":[16,16],"camellia-192-cfb":[24,16],"camellia-256-cfb":[32,16],"cast5-cfb":[16,8],"des-cfb":[8,8],"idea-cfb":[16,8],"rc2-cfb":[16,8],rc4:[16,0],"rc4-md5":[16,16],"seed-cfb":[16,16]},l=function(e,t,r){var n=d.createHash("md5");return n.update(e),n.update(t),n=n.digest(),1===r?d.createCipheriv("rc4",n,""):d.createDecipheriv("rc4",n,"")},e.prototype.get_cipher_len=function(e){return e=e.toLowerCase(),t[e]},e.prototype.get_cipher=function(e,t,r,n){var o,i;if(t=t.toLowerCase(),e=new Buffer(e,"binary"),null!=(o=this.get_cipher_len(t)))return e=(i=s(e,o[0],o[1]))[0],i=i[1],null==n&&(n=i),1===r&&(this.cipher_iv=n.slice(0,o[1])),n=n.slice(0,o[1]),"rc4-md5"===t?l(e,n,r):1===r?d.createCipheriv(t,e,n):d.createDecipheriv(t,e,n)},e.prototype.encrypt=function(e){var t;return null!=this.method?(t=this.cipher.update(e),this.iv_sent?t:(this.iv_sent=!0,Buffer.concat([this.cipher_iv,t]))):n(this.encryptTable,e)},e.prototype.decrypt=function(e){var t,r;return null!=this.method?null==this.decipher?(r=this.get_cipher_len(this.method)[1],t=e.slice(0,r),this.decipher=this.get_cipher(this.key,this.method,0,t),this.decipher.update(e.slice(r))):this.decipher.update(e):n(this.decryptTable,e)},{getTable:r,Encryptor:e}}e.Server=function(){WebSocketServer=p.Server;var e=r().Encryptor;function t(e,t,r,n){if(void 0===e||void 0===t)throw new Error("MissingRequireParamaters");r={server:"www.example.com",local_address:"0.0.0.0",scheme:"ws",local_port:e,remote_port:80,password:t,timeout:n||600,method:r||"aes-256-cfb"};this.timeout=Math.floor(1e3*r.timeout),this.PORT=r.remote_port,this.LOCAL_ADDRESS=r.local_address,this.KEY=r.password,this.METHOD=r.method,this.server=null,this.wss=null}return t.prototype.createServer=function(r){r=r||'<!DOCTYPE html><html><head><meta charset="utf-8"><title>歡迎使用daonodess</title><style>body {text-align:center;}</style></head><body><div><h1>DaoNodeSS</h1><p>看到此頁面代表程序正確運行</p><p>本程式改自shadowsocks-heroku，目的是把這個專案Docker化</p><p>並支援自己設定參數</p><p>原GitHub帳戶搞丟了，目前repo放在我的主帳</p></div></body></html>',this.server=n.createServer(function(e,t){return t.writeHead(200,{"Content-Type":"text/html"}),t.end(r)}),this.server.listen(this.PORT,this.LOCAL_ADDRESS,function(){var e=this.server.address();return console.log("server listening at",e)}.bind(this)),this.server.on("error",function(e){return"EADDRINUSE"===e.code&&console.log("address in use, aborting"),process.exit(1)})},t.prototype.createSocket=function(){if(null===this.server)throw new Error("HTTPServerNotInitialized");this.wss=new WebSocketServer({server:this.server}),this.wss.on("connection",function(o){var i,s,c,l,h,u,a,d;return console.log("server connected"),console.log("concurrent connections:",wss.clients.length),c=new e(KEY,METHOD),s=[],i=l=d=0,a=u=h=null,o.on("message",function(e,t){var r,n;if(e=c.decrypt(e),5!==d){if(0===d)try{if(3===(r=e[0]))i=e[1];else if(1!==r)return console.warn("unsupported addrtype: "+r),void o.close();return l=1===r?(n=e.slice(1,5),u=n[0]+"."+n[1]+"."+n[2]+"."+n[3],a=e.readUInt16BE(5),7):(u=e.slice(2,2+i).toString("binary"),a=e.readUInt16BE(2+i),2+i+2),(h=f.connect(a,u,function(){var e,t;for(console.log("connecting",u),e=0;e<s.length;)t=s[e],h.write(t),e++;return s=null,d=5})).on("data",function(e){e=c.encrypt(e),o.readyState===p.OPEN&&(o.send(e,{binary:!0}),0<o.bufferedAmount&&h.pause())}),h.on("end",function(){return o.close(),console.log("remote disconnected")}),h.on("drain",function(){return o._socket.resume()}),h.on("error",function(e){return o.terminate(),console.log("remote: "+e)}),h.setTimeout(timeout,function(){return console.log("remote timeout"),h.destroy(),o.close()}),e.length>l&&(n=new Buffer(e.length-l),e.copy(n,0,l),s.push(n),n=null),d=4}catch(e){return console.warn(e),h&&h.destroy(),o.close()}else if(4===d)return s.push(e)}else h.write(e)||o._socket.pause()}),o.on("ping",function(){return o.pong("",null,!0)}),o._socket.on("drain",function(){if(5===d)return h.resume()}),o.on("close",function(){if(console.log("server disconnected"),console.log("concurrent connections:",wss.clients.length),h)return h.destroy()}),o.on("error",function(e){if(console.warn("server: "+e),console.log("concurrent connections:",wss.clients.length),h)return h.destroy()})})},t}()}(global.Server||global);